# Ralph Progress Log
Started: 2025-01-07
Target: Journal Enhancements

## Codebase Patterns

### Astro Site
- Content collection: Use `getCollection('journal')` for entries
- Schema: Defined in `site/src/content/config.ts` with Zod
- CSS variables: Monochrome palette in `:root` of `global.css`
- Entry types: daily, weekly, monthly (add yearly when needed)
- File paths: `journal/YYYY/MM/YYYY-MM-DD.md` for daily entries

### Neovim Lua
- Dates: `os.date("*t")` returns table, `os.time()` for unix timestamp
- Templates: Use `{{PLACEHOLDER}}` syntax for date substitution
- Commands: Create with `nvim_create_user_command`
- Keymaps: Create with `vim.keymap.set`
- Async jobs: Use `vim.fn.jobstart` for non-blocking builds

### Templates
- Frontmatter: YAML between `---` markers
- Required fields: title, date, type
- Optional fields: mood, tags, draft
- Placeholders: {{DATE}}, {{YEAR}}, {{MONTH}}, {{WEEK}}, {{WEEKDAY}}

## Key Files

- site/src/content/config.ts - Zod schema for frontmatter
- site/src/styles/global.css - Monochrome design system
- nvim/journal.lua - All Neovim commands and keymaps
- templates/*.md - Entry templates

---

## 2025-01-07 - Initial Setup

- Created journal project from PRD
- Implemented Astro static site with monochrome design
- Created Neovim integration without plugins
- Set up templates for daily, weekly, monthly entries
- **Learnings:**
  - Astro content collections require explicit schema
  - Neovim autocmd pattern must match exact directory path
  - BufWritePost can trigger builds on save

---

## 2025-01-07 - Code Review

- Ran 4 parallel review agents comparing codebase to plan
- Identified critical issues:
  - Duplicate keymap `<leader>jn` (lines 276, 280)
  - Gray-light color fails WCAG AA (2.85:1 contrast)
  - No date validation bounds
  - Missing EB Garamond font import
- Created prd.json with 15 user stories
- **Learnings:**
  - WCAG AA requires 4.5:1 contrast for normal text
  - Neovim keymaps can silently override each other
  - Always validate user input dates

---

## 2026-01-07 - US-001, US-002, US-003

- US-001: Already resolved - keymaps refactored to use `<leader>jj`, `jw`, `jm` etc.
- US-002: Updated `--gray-light` from #999999 to #525252 (7.14:1 contrast)
- US-003: Added `validate_date()` function with bounds checking
- Files changed: `site/src/styles/global.css`, `nvim/journal.lua`
- **Learnings:**
  - Lua's `os.time()` normalizes invalid dates (Feb 30 → Mar 2), compare to detect errors
  - WCAG AA requires 4.5:1 contrast, AAA requires 7:1; #525252 exceeds both
  - Date validation should use `os.time` + normalization check for leap year handling

---

## 2026-01-07 - Design System Implementation (US-016 through US-030)

- Completed 15 design system stories implementing editorial/magazine aesthetic
- Key changes:
  - Pure monochrome palette (black, white, muted, muted-foreground)
  - Editorial typography (Playfair Display, Source Serif 4, JetBrains Mono)
  - Dramatic type scale (xs through 9xl)
  - Sharp corners everywhere (border-radius: 0)
  - Border weight system (hairline, thin, medium, thick, ultra)
  - Paper texture overlay
  - Instant (100ms) hover transitions
  - Focus states for accessibility
  - Drop caps, oversized dates, inverted hero
  - Pull quote styling for blockquotes
  - Color inversion on hover for archive items
  - Tags as uppercase monospace labels with borders
- **Learnings:**
  - CSS ::before can create texture overlays without affecting interactivity
  - :focus-visible prevents outlines on mouse clicks while preserving keyboard a11y
  - Negative margins can expand clickable areas beyond container
  - CSS custom properties work well for design systems (tokens)

---

## 2026-01-07 - Additional Enhancements (US-005, US-031, US-032, US-034)

- US-005: Created /tags index page with alphabetical listing and counts
- US-031: Increased container to 72rem with responsive padding (4rem→8rem)
- US-032: Responsive typography scaling (headlines reduce on mobile)
- US-034: Added skip link for keyboard accessibility
- **Learnings:**
  - Astro pages can reduce collections to compute aggregates like tag counts
  - Skip links need both position:absolute and z-index for proper layering
  - Responsive design should scale typography, not hide content

---

## 2026-01-07 - US-006 Full-text Search

- Created `/search` route with client-side search functionality
- Built JSON search index at build time containing title, content, tags, mood
- Implemented weighted scoring: title (10) > tags (8) > mood (5) > content (3)
- Added term highlighting using `<mark>` tags with color inversion
- Stored recent searches in localStorage (max 5)
- Files changed: `site/src/pages/search.astro`
- **Learnings:**
  - Static sites can implement search via build-time JSON index + client-side JS
  - `define:vars` in Astro scripts injects server data into client scripts
  - Debounced input (200ms) prevents excessive re-renders during typing
  - `:global(mark)` in scoped CSS targets dynamically injected elements

---

## 2026-01-07 - US-007 Yearly Review Template

- Created `templates/yearly.md` with 10 reflection sections
- Added 'yearly' to content schema type enum
- Updated journal.lua to handle yearly entry type
- Added `:JournalNew year` command and `<leader>jy` keymap
- Files changed: `templates/yearly.md`, `site/src/content/config.ts`, `nvim/journal.lua`
- **Learnings:**
  - Yearly reviews need different prompts than daily (retrospective + forward-looking)
  - Zod enums can be extended by adding values to array
  - Template placeholders like {{YEAR}}+1 don't auto-increment; handled manually in template

---

## 2026-01-07 - US-008 Sleep Tracking

- Added `sleep_hours` optional field to content schema with 0-24 validation
- Added Sleep section to daily template with quality prompts
- Updated entry layout to display sleep alongside mood in meta row
- Added CSS for entry-meta flex layout
- Files changed: `site/src/content/config.ts`, `templates/daily.md`, `site/src/layouts/EntryLayout.astro`, `site/src/styles/global.css`
- **Learnings:**
  - Zod `.min(0).max(24)` provides clean numeric range validation
  - Flex layout with gap works well for optional metadata display
  - Keep frontmatter fields optional when user may not always track them

---

## 2026-01-07 - US-009 Energy Level Tracking

- Added `energy` optional field (1-10 integer) to content schema
- Added Energy Level section with scale prompt in Evening section
- Display energy as visual dot indicator: filled (●) + empty (○)
- Used JS string repeat for dynamic dot generation
- Files changed: `site/src/content/config.ts`, `templates/daily.md`, `site/src/layouts/EntryLayout.astro`, `site/src/styles/global.css`
- **Learnings:**
  - Zod `.int()` ensures whole numbers only
  - String `.repeat(n)` is elegant for generating visual indicators
  - Unicode filled/empty circles (●○) work well for monochrome displays

---

## 2026-01-07 - US-010 Dark Mode Support

- Added `prefers-color-scheme: dark` media query with CSS custom property overrides
- Inverted palette: --black↔--white, --muted→#1A1A1A, --muted-foreground→#A3A3A3
- Added neutral gray texture (128,128,128) that works in both modes
- Created fixed toggle button with sun/moon icons (44px touch target)
- Applied theme before render using inline script to prevent flash
- Persisted choice in localStorage
- Files changed: `site/src/styles/global.css`, `site/src/layouts/BaseLayout.astro`
- **Learnings:**
  - `:root:not([data-theme="light"])` respects system preference unless overridden
  - Inline script in `<head>` with `is:inline` runs before render in Astro
  - Monochrome designs invert perfectly - just swap black/white values

---

## 2026-01-07 - US-011 Timeline Visualization

- Created `/timeline` route with vertical chronological view
- Entries displayed as points on 4px black line with alternating left/right layout
- Square timeline points (16x16) with medium border, mood emoji adjacent
- Year and month dropdowns for filtering (client-side JS with `define:vars`)
- Entry count updates dynamically based on filter selection
- Cards show date, type badge, and energy dots (if available)
- Full color inversion on hover (matching archive list pattern)
- Responsive: single column on mobile with timeline line at left edge
- Files changed: `site/src/pages/timeline.astro`
- **Learnings:**
  - Alternating sides achieved with `index % 2` and CSS positioning
  - `dataset` attributes + client-side JS enable filtering without full page reload
  - Timeline points can host adjacent content (mood) via absolute positioning
  - Square timeline points match editorial "sharp corners" design system

---

## 2026-01-07 - US-012 Calendar Heat Map

- Created `/calendar` route with year-at-a-glance 12-month grid
- 4-column responsive layout (3 on tablet, 2 on mobile, 1 on small screens)
- Binary heat map: black fill = entry exists, white = no entry
- Each month shows 7-column day grid with weekday headers (S M T W T F S)
- Entry counts displayed per month and total for year
- Year selector allows switching between years (client-side rendering)
- Days with entries are clickable links to the entry page
- Inverted hover state on entry days (white text on black becomes black on white)
- Files changed: `site/src/pages/calendar.astro`
- **Learnings:**
  - Calendar generation needs `startDayOfWeek` offset for proper alignment
  - `aspect-ratio: 1` keeps day cells square regardless of content
  - Pre-computing all years' data allows instant client-side switching
  - Binary (black/white) heat map is cleaner than gradient for monochrome design

---

## 2026-01-07 - US-013 Export Functionality

- Added `:JournalExport` command with optional date range and format arguments
- Usage: `:JournalExport [start_date] [end_date] [json|markdown]`
- Markdown export: concatenated entries with ## headers, mood metadata, section dividers
- JSON export: structured `{entries: [{date, metadata, content}]}` format
- Simple YAML frontmatter parsing (handles common fields)
- JSON escaping for special characters (\n, \t, ", \\)
- Output file auto-named with timestamp, opens after creation
- Added `<leader>je` keymap for quick export
- Files changed: `nvim/journal.lua`
- **Learnings:**
  - Lua lacks native JSON; manual string building works for simple structures
  - YAML frontmatter parsing via regex handles most common cases
  - `os.time()` comparison enables efficient date range filtering
  - Export is read-only, doesn't modify source files

---

## 2026-01-07 - US-014 Random Past Entry

- Added `:JournalRandom` command to open a random past entry
- Skips entries from current week (calculates week start using `wday`)
- Shows notification with: date, weekday name, and relative time ("3 months ago")
- Relative time adapts: days for <30, months for <365, years otherwise
- Uses `math.randomseed(os.time())` for varied selection
- Added `<leader>jr` keymap
- Files changed: `nvim/journal.lua`
- **Learnings:**
  - Lua's `os.date("*t").wday` returns 1=Sunday, so `wday-1` gives days since Sunday
  - Week boundary calculation needs time normalization to midnight
  - Random rediscovery encourages reflection without explicit search

---

## 2026-01-07 - US-015 Streak Tracking

- Implemented streak calculation in both Lua (Neovim) and TypeScript (Astro)
- Current streak: counts consecutive days from today/yesterday going backwards
- Longest streak: iterates all dates, tracks max consecutive run
- DST tolerance: allows ±1 hour variance in "one day" calculation
- Neovim shows streak in startup notification + `:JournalStreak` command
- Site displays streak in hero section with monospace typography
- Only shows longest when greater than current (to avoid redundancy)
- Added `<leader>js` keymap
- Files changed: `nvim/journal.lua`, `site/src/pages/index.astro`, `site/src/styles/global.css`
- **Learnings:**
  - Streak logic must handle "no entry today but yesterday continues streak"
  - Normalizing times to noon prevents timezone/DST edge cases
  - Duplicate implementation (Lua + TS) needed because Neovim and Astro run separately

---

## 2026-01-07 - US-033 Editorial Navigation

- Added site-wide navigation in BaseLayout.astro
- Five links: Archive, Timeline, Calendar, Tags, Search
- Editorial masthead styling: uppercase, tracking-widest, monospace font
- Active page indicated by 4px bottom border (matches design system thick border)
- Full color inversion on hover (100ms transition)
- Active state detection via `Astro.url.pathname` comparison
- Responsive padding matching container breakpoints
- Files changed: `site/src/layouts/BaseLayout.astro`, `site/src/styles/global.css`
- **Learnings:**
  - `class:list` in Astro allows conditional class application
  - `aria-current="page"` improves screen reader navigation context
  - Border-bottom for active state preserves clickable area (vs underline)

---
