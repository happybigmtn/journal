---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// In production, only show published entries; in dev, show all non-draft entries
const allEntries = await getCollection('journal', ({ data }) =>
  !data.draft && (import.meta.env.DEV || data.published)
);

// Habits to track
const habitsConfig = ['anki', 'math', 'kindle', 'yoga', 'cardio', 'weights'];

// Parse habits from markdown body
const parseHabits = (body: string) => {
  const habits: Record<string, boolean | null> = {};
  habitsConfig.forEach(habit => {
    // Match patterns like "- anki: yes" or "- anki: no" or "- anki: yes no"
    const regex = new RegExp(`-\\s*${habit}:\\s*(yes|no)(?:\\s|$)`, 'i');
    const match = body.match(regex);
    if (match) {
      habits[habit] = match[1].toLowerCase() === 'yes';
    } else {
      habits[habit] = null; // Not yet answered (still "yes no")
    }
  });
  return habits;
};

// Get habit data from all entries
const entriesWithHabits = allEntries
  .map(e => ({
    date: e.data.date,
    habits: parseHabits(e.body),
    slug: e.slug,
  }))
  .filter(e => Object.values(e.habits).some(v => v !== null))
  .sort((a, b) => a.date.getTime() - b.date.getTime());

// Calculate habit completion rates
const habitStats = habitsConfig.map(habit => {
  const completed = entriesWithHabits.filter(e => e.habits[habit] === true).length;
  const total = entriesWithHabits.filter(e => e.habits[habit] !== null).length;
  const rate = total > 0 ? (completed / total) * 100 : null;
  return { habit, completed, total, rate };
});

// Vitals keys, labels, and scales (different metrics have different ranges)
const vitalsConfig = [
  { key: 'sleep', label: 'Sleep', description: 'Sleep quality', max: 100 },
  { key: 'recovery', label: 'Recovery', description: 'Recovery from yesterday', max: 100 },
  { key: 'physical', label: 'Physical', description: 'Body wellness', max: 20 },
  { key: 'energy', label: 'Energy', description: 'Overall energy', max: 10 },
  { key: 'stress', label: 'Stress', description: 'Stress level (lower is better)', max: 10, inverted: true },
  { key: 'mood', label: 'Mood', description: 'Emotional state', max: 10 },
  { key: 'focus', label: 'Focus', description: 'Mental clarity', max: 10 },
  { key: 'nutrition', label: 'Nutrition', description: 'Food quality', max: 10 },
  { key: 'kindness', label: 'Kindness', description: 'Acts of compassion', max: 10 },
];

// Get entries with vitals data
const entriesWithVitals = allEntries
  .filter(e => e.data.vitals && Object.values(e.data.vitals).some(v => v !== undefined))
  .map(e => ({
    date: e.data.date,
    vitals: e.data.vitals,
    slug: e.slug,
  }))
  .sort((a, b) => a.date.getTime() - b.date.getTime());

const totalEntries = entriesWithVitals.length;

// Calculate averages for each vital
const vitalsAverages = vitalsConfig.map(({ key, label, description, max, inverted }) => {
  const values = entriesWithVitals
    .map(e => e.vitals?.[key as keyof typeof e.vitals])
    .filter((v): v is number => v !== undefined && v !== null);

  const avg = values.length > 0
    ? (values.reduce((sum, v) => sum + v, 0) / values.length)
    : null;

  return { key, label, description, max, avg, count: values.length, inverted };
});

// Recent trend data (last 14 entries)
const recentEntries = entriesWithVitals.slice(-14);

// Calculate composite health score (normalize all to 0-100, invert stress)
const calculateHealthScore = (vitals: any) => {
  const values: number[] = [];
  vitalsConfig.forEach(({ key, max, inverted }) => {
    const val = vitals?.[key];
    if (val !== undefined && val !== null) {
      // Normalize to 0-100 scale
      const normalized = (val / max) * 100;
      values.push(inverted ? (100 - normalized) : normalized);
    }
  });
  return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : null;
};

const recentHealthScores = recentEntries.map(e => ({
  date: e.date,
  score: calculateHealthScore(e.vitals),
}));

// Overall health score (normalized to 0-100)
const overallHealthScore = vitalsAverages.some(v => v.avg !== null)
  ? (() => {
      const validVitals = vitalsAverages.filter(v => v.avg !== null);
      const sum = validVitals.reduce((acc, v) => {
        const normalized = (v.avg! / v.max) * 100;
        return acc + (v.inverted ? (100 - normalized) : normalized);
      }, 0);
      return sum / validVitals.length;
    })()
  : null;

// Format date for display
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};
---

<BaseLayout title="Insights">
  <h1 class="page-title">Insights</h1>

  {totalEntries === 0 ? (
    <p class="empty-state">No vitals data yet. Rate your daily vitals (1-10) to see insights.</p>
  ) : (
    <>
      <section class="stats-overview">
        <div class="stat-card">
          <span class="stat-value">{totalEntries}</span>
          <span class="stat-label">days tracked</span>
        </div>
        {overallHealthScore !== null && (
          <div class="stat-card">
            <span class="stat-value">{overallHealthScore.toFixed(1)}</span>
            <span class="stat-label">health score</span>
          </div>
        )}
      </section>

      <section class="insight-section">
        <h2>Vitals Averages</h2>
        <div class="vitals-chart">
          {vitalsAverages.map(vital => (
            <div class="vital-row">
              <span class="vital-label">{vital.label}</span>
              <div class="vital-bar-container">
                {vital.avg !== null && (
                  <div
                    class:list={["vital-bar-fill", { inverted: vital.inverted }]}
                    style={`width: ${(vital.avg / vital.max) * 100}%`}
                  />
                )}
              </div>
              <span class="vital-value">
                {vital.avg !== null ? `${vital.avg.toFixed(0)}/${vital.max}` : '-'}
              </span>
            </div>
          ))}
        </div>
      </section>

      {recentHealthScores.length > 3 && (
        <section class="insight-section">
          <h2>Health Trend</h2>
          <p class="section-subtitle">last {recentHealthScores.length} days</p>
          <div class="trend-chart">
            <div class="trend-line">
              {recentHealthScores.map((entry, i) => (
                <div class="trend-point-wrapper">
                  {entry.score !== null && (
                    <div
                      class="trend-point"
                      style={`bottom: ${entry.score}%`}
                      title={`${formatDate(entry.date)}: ${entry.score.toFixed(0)}%`}
                    />
                  )}
                  <span class="trend-date">{formatDate(entry.date)}</span>
                </div>
              ))}
            </div>
            <div class="trend-scale">
              <span>100</span>
              <span>50</span>
              <span>0</span>
            </div>
          </div>
        </section>
      )}

      <section class="insight-section">
        <h2>Individual Trends</h2>
        <p class="section-subtitle">last {recentEntries.length} days</p>
        <div class="individual-trends">
          {vitalsConfig.map(({ key, label, max }) => {
            const data = recentEntries.map(e => ({
              date: e.date,
              value: e.vitals?.[key as keyof typeof e.vitals],
            }));
            const hasData = data.some(d => d.value !== undefined && d.value !== null);

            return hasData && (
              <div class="mini-trend">
                <span class="mini-trend-label">{label}</span>
                <div class="mini-trend-chart">
                  {data.map(d => (
                    <div class="mini-bar-wrapper">
                      {d.value !== undefined && d.value !== null && (
                        <div
                          class="mini-bar"
                          style={`height: ${(d.value / max) * 100}%`}
                        />
                      )}
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </section>

      {entriesWithHabits.length > 0 && (
        <section class="insight-section">
          <h2>Habits</h2>
          <p class="section-subtitle">{entriesWithHabits.length} days tracked</p>
          <div class="habits-chart">
            {habitStats.map(({ habit, completed, total, rate }) => (
              <div class="habit-row">
                <span class="habit-label">{habit}</span>
                <div class="habit-bar-container">
                  {rate !== null && (
                    <div
                      class="habit-bar-fill"
                      style={`width: ${rate}%`}
                    />
                  )}
                </div>
                <span class="habit-value">
                  {rate !== null ? `${completed}/${total}` : '-'}
                </span>
              </div>
            ))}
          </div>
        </section>
      )}
    </>
  )}
</BaseLayout>

<style>
  .page-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 400;
    font-style: italic;
    color: var(--fg-muted);
    margin-bottom: 2rem;
  }

  .empty-state {
    color: var(--fg-muted);
    font-style: italic;
    padding: 2rem 0;
  }

  .stats-overview {
    display: flex;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .stat-card {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: var(--text-2xl);
    color: var(--accent);
  }

  .stat-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
  }

  .insight-section {
    margin-bottom: 3rem;
  }

  .insight-section h2 {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-style: italic;
    color: var(--fg-muted);
    margin-bottom: 0.5rem;
  }

  .section-subtitle {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    margin-bottom: 1rem;
    opacity: 0.7;
  }

  /* Vitals averages chart */
  .vitals-chart {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .vital-row {
    display: grid;
    grid-template-columns: 5rem 1fr 4rem;
    gap: 1rem;
    align-items: center;
  }

  .vital-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    text-transform: lowercase;
  }

  .vital-bar-container {
    height: 6px;
    background: var(--bg-elevated);
    position: relative;
  }

  .vital-bar-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: var(--accent);
  }

  .vital-bar-fill.inverted {
    background: #a88272;
  }

  .vital-value {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--accent);
    text-align: right;
  }

  /* Habits chart */
  .habits-chart {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .habit-row {
    display: grid;
    grid-template-columns: 5rem 1fr 3rem;
    gap: 1rem;
    align-items: center;
  }

  .habit-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    text-transform: lowercase;
  }

  .habit-bar-container {
    height: 6px;
    background: var(--bg-elevated);
    position: relative;
  }

  .habit-bar-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: var(--accent);
  }

  .habit-value {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--accent);
    text-align: right;
  }

  /* Health trend chart */
  .trend-chart {
    display: flex;
    gap: 1rem;
    height: 120px;
  }

  .trend-line {
    flex: 1;
    display: flex;
    align-items: flex-end;
    gap: 2px;
    position: relative;
    background: var(--bg-elevated);
    padding: 0.5rem;
  }

  .trend-point-wrapper {
    flex: 1;
    height: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  .trend-point {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
  }

  .trend-date {
    font-family: var(--font-mono);
    font-size: 0.5rem;
    color: var(--fg-muted);
    text-align: center;
    opacity: 0.5;
    margin-top: auto;
    display: none;
  }

  .trend-point-wrapper:first-child .trend-date,
  .trend-point-wrapper:last-child .trend-date {
    display: block;
  }

  .trend-scale {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    opacity: 0.5;
  }

  /* Individual mini trends */
  .individual-trends {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 1rem;
  }

  .mini-trend {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mini-trend-label {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    color: var(--fg-muted);
    text-transform: lowercase;
  }

  .mini-trend-chart {
    display: flex;
    align-items: flex-end;
    gap: 1px;
    height: 40px;
    background: var(--bg-elevated);
    padding: 2px;
  }

  .mini-bar-wrapper {
    flex: 1;
    height: 100%;
    display: flex;
    align-items: flex-end;
  }

  .mini-bar {
    width: 100%;
    background: var(--accent);
    min-height: 1px;
  }

  @media (max-width: 640px) {
    .stats-overview {
      flex-direction: column;
      gap: 1rem;
    }

    .vital-row {
      grid-template-columns: 4rem 1fr 3.5rem;
      gap: 0.5rem;
    }

    .individual-trends {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
