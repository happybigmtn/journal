---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// In production, only show published entries; in dev, show all non-draft entries
const allEntries = await getCollection('journal', ({ data }) =>
  !data.draft && (import.meta.env.DEV || data.published)
);

// Vitals keys and labels
const vitalsConfig = [
  { key: 'sleep', label: 'Sleep', description: 'Sleep quality' },
  { key: 'recovery', label: 'Recovery', description: 'Recovery from yesterday' },
  { key: 'energy', label: 'Energy', description: 'Overall energy' },
  { key: 'stress', label: 'Stress', description: 'Stress level (lower is better)', inverted: true },
  { key: 'mood', label: 'Mood', description: 'Emotional state' },
  { key: 'focus', label: 'Focus', description: 'Mental clarity' },
  { key: 'physical', label: 'Physical', description: 'Body wellness' },
  { key: 'nutrition', label: 'Nutrition', description: 'Food quality' },
  { key: 'kindness', label: 'Kindness', description: 'Acts of compassion' },
  { key: 'exercise', label: 'Exercise', description: 'Physical activity' },
];

// Get entries with vitals data
const entriesWithVitals = allEntries
  .filter(e => e.data.vitals && Object.values(e.data.vitals).some(v => v !== undefined))
  .map(e => ({
    date: e.data.date,
    vitals: e.data.vitals,
    slug: e.slug,
  }))
  .sort((a, b) => a.date.getTime() - b.date.getTime());

const totalEntries = entriesWithVitals.length;

// Calculate averages for each vital
const vitalsAverages = vitalsConfig.map(({ key, label, description, inverted }) => {
  const values = entriesWithVitals
    .map(e => e.vitals?.[key as keyof typeof e.vitals])
    .filter((v): v is number => v !== undefined);

  const avg = values.length > 0
    ? (values.reduce((sum, v) => sum + v, 0) / values.length)
    : null;

  return { key, label, description, avg, count: values.length, inverted };
});

// Recent trend data (last 14 entries)
const recentEntries = entriesWithVitals.slice(-14);

// Calculate composite health score (average of all vitals, with stress inverted)
const calculateHealthScore = (vitals: any) => {
  const values: number[] = [];
  vitalsConfig.forEach(({ key, inverted }) => {
    const val = vitals?.[key];
    if (val !== undefined) {
      values.push(inverted ? (11 - val) : val); // Invert stress
    }
  });
  return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : null;
};

const recentHealthScores = recentEntries.map(e => ({
  date: e.date,
  score: calculateHealthScore(e.vitals),
}));

const overallHealthScore = vitalsAverages.every(v => v.avg !== null)
  ? vitalsAverages.reduce((sum, v) => {
      const val = v.avg!;
      return sum + (v.inverted ? (11 - val) : val);
    }, 0) / vitalsAverages.length
  : null;

// Format date for display
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};
---

<BaseLayout title="Insights">
  <h1 class="page-title">Insights</h1>

  {totalEntries === 0 ? (
    <p class="empty-state">No vitals data yet. Rate your daily vitals (1-10) to see insights.</p>
  ) : (
    <>
      <section class="stats-overview">
        <div class="stat-card">
          <span class="stat-value">{totalEntries}</span>
          <span class="stat-label">days tracked</span>
        </div>
        {overallHealthScore !== null && (
          <div class="stat-card">
            <span class="stat-value">{overallHealthScore.toFixed(1)}</span>
            <span class="stat-label">health score</span>
          </div>
        )}
      </section>

      <section class="insight-section">
        <h2>Vitals Averages</h2>
        <div class="vitals-chart">
          {vitalsAverages.map(vital => (
            <div class="vital-row">
              <span class="vital-label">{vital.label}</span>
              <div class="vital-bar-container">
                {vital.avg !== null && (
                  <div
                    class:list={["vital-bar-fill", { inverted: vital.inverted }]}
                    style={`width: ${vital.avg * 10}%`}
                  />
                )}
              </div>
              <span class="vital-value">
                {vital.avg !== null ? vital.avg.toFixed(1) : '-'}
              </span>
            </div>
          ))}
        </div>
      </section>

      {recentHealthScores.length > 3 && (
        <section class="insight-section">
          <h2>Health Trend</h2>
          <p class="section-subtitle">last {recentHealthScores.length} days</p>
          <div class="trend-chart">
            <div class="trend-line">
              {recentHealthScores.map((entry, i) => (
                <div class="trend-point-wrapper">
                  {entry.score !== null && (
                    <div
                      class="trend-point"
                      style={`bottom: ${(entry.score / 10) * 100}%`}
                      title={`${formatDate(entry.date)}: ${entry.score.toFixed(1)}`}
                    />
                  )}
                  <span class="trend-date">{formatDate(entry.date)}</span>
                </div>
              ))}
            </div>
            <div class="trend-scale">
              <span>10</span>
              <span>5</span>
              <span>0</span>
            </div>
          </div>
        </section>
      )}

      <section class="insight-section">
        <h2>Individual Trends</h2>
        <p class="section-subtitle">last {recentEntries.length} days</p>
        <div class="individual-trends">
          {vitalsConfig.map(({ key, label }) => {
            const data = recentEntries.map(e => ({
              date: e.date,
              value: e.vitals?.[key as keyof typeof e.vitals],
            }));
            const hasData = data.some(d => d.value !== undefined);

            return hasData && (
              <div class="mini-trend">
                <span class="mini-trend-label">{label}</span>
                <div class="mini-trend-chart">
                  {data.map(d => (
                    <div class="mini-bar-wrapper">
                      {d.value !== undefined && (
                        <div
                          class="mini-bar"
                          style={`height: ${d.value * 10}%`}
                        />
                      )}
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </section>
    </>
  )}
</BaseLayout>

<style>
  .page-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 400;
    font-style: italic;
    color: var(--fg-muted);
    margin-bottom: 2rem;
  }

  .empty-state {
    color: var(--fg-muted);
    font-style: italic;
    padding: 2rem 0;
  }

  .stats-overview {
    display: flex;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .stat-card {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: var(--text-2xl);
    color: var(--accent);
  }

  .stat-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
  }

  .insight-section {
    margin-bottom: 3rem;
  }

  .insight-section h2 {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-style: italic;
    color: var(--fg-muted);
    margin-bottom: 0.5rem;
  }

  .section-subtitle {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    margin-bottom: 1rem;
    opacity: 0.7;
  }

  /* Vitals averages chart */
  .vitals-chart {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .vital-row {
    display: grid;
    grid-template-columns: 5rem 1fr 2rem;
    gap: 1rem;
    align-items: center;
  }

  .vital-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    text-transform: lowercase;
  }

  .vital-bar-container {
    height: 6px;
    background: var(--bg-elevated);
    position: relative;
  }

  .vital-bar-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: var(--accent);
  }

  .vital-bar-fill.inverted {
    background: #a88272;
  }

  .vital-value {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--accent);
    text-align: right;
  }

  /* Health trend chart */
  .trend-chart {
    display: flex;
    gap: 1rem;
    height: 120px;
  }

  .trend-line {
    flex: 1;
    display: flex;
    align-items: flex-end;
    gap: 2px;
    position: relative;
    background: var(--bg-elevated);
    padding: 0.5rem;
  }

  .trend-point-wrapper {
    flex: 1;
    height: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  .trend-point {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
  }

  .trend-date {
    font-family: var(--font-mono);
    font-size: 0.5rem;
    color: var(--fg-muted);
    text-align: center;
    opacity: 0.5;
    margin-top: auto;
    display: none;
  }

  .trend-point-wrapper:first-child .trend-date,
  .trend-point-wrapper:last-child .trend-date {
    display: block;
  }

  .trend-scale {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    opacity: 0.5;
  }

  /* Individual mini trends */
  .individual-trends {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 1rem;
  }

  .mini-trend {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mini-trend-label {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    color: var(--fg-muted);
    text-transform: lowercase;
  }

  .mini-trend-chart {
    display: flex;
    align-items: flex-end;
    gap: 1px;
    height: 40px;
    background: var(--bg-elevated);
    padding: 2px;
  }

  .mini-bar-wrapper {
    flex: 1;
    height: 100%;
    display: flex;
    align-items: flex-end;
  }

  .mini-bar {
    width: 100%;
    background: var(--accent);
    min-height: 1px;
  }

  @media (max-width: 640px) {
    .stats-overview {
      flex-direction: column;
      gap: 1rem;
    }

    .vital-row {
      grid-template-columns: 4rem 1fr 1.5rem;
      gap: 0.5rem;
    }

    .individual-trends {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
