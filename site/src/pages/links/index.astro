---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const articles = await getCollection('articles');

// Sort by date descending (newest first)
const sortedArticles = articles.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
};
---

<BaseLayout title="Articles">
  <div class="articles-header">
    <h1 class="page-title">Articles</h1>
    <div class="search-container" id="search-container">
      <span class="search-prefix">/</span>
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="search..."
        autocomplete="off"
      />
    </div>
  </div>
  <p class="page-subtitle">Saved reads worth revisiting</p>

  {sortedArticles.length === 0 ? (
    <p class="empty-state">No articles saved yet.</p>
  ) : (
    <ul class="article-list" id="article-list">
      {sortedArticles.map((article, index) => (
        <li data-index={index}>
          <a href={`/articles/${article.slug}`} class="article-link" data-title={article.data.title.toLowerCase()}>
            <span class="article-title">{article.data.title}</span>
            <span class="article-meta">
              {article.data.author && <span class="author">{article.data.author}</span>}
              {article.data.source && <span class="source">{article.data.source}</span>}
              <span class="date">{formatDate(article.data.date)}</span>
            </span>
          </a>
          {article.data.tags && article.data.tags.length > 0 && (
            <div class="article-tags">
              {article.data.tags.map(tag => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          )}
        </li>
      ))}
    </ul>
  )}

  <div class="vim-hint" id="vim-hint">
    <kbd>/</kbd> search <kbd>j</kbd><kbd>k</kbd> navigate <kbd>enter</kbd> open <kbd>esc</kbd> close
  </div>
</BaseLayout>

<style>
  .articles-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .page-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 400;
    font-style: italic;
    color: var(--fg-muted);
    margin: 0;
  }

  .search-container {
    display: none;
    align-items: center;
    gap: 0.25rem;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
  }

  .search-container.active {
    display: flex;
  }

  .search-prefix {
    color: var(--accent);
  }

  .search-input {
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border-color);
    color: var(--fg);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    padding: 0.25rem 0;
    width: 150px;
    outline: none;
  }

  .search-input:focus {
    border-bottom-color: var(--accent);
  }

  .page-subtitle {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    opacity: 0.7;
    margin-bottom: 2rem;
  }

  .empty-state {
    color: var(--fg-muted);
    font-style: italic;
    padding: 2rem 0;
  }

  .article-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .article-list li {
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }

  .article-list li:last-child {
    border-bottom: none;
  }

  .article-list li.hidden {
    display: none;
  }

  .article-list li.selected .article-link {
    background: var(--bg-elevated);
    margin: 0 -1rem;
    padding: 0.75rem 1rem;
  }

  .article-list li.selected .article-title {
    color: var(--accent);
  }

  .article-link {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    text-decoration: none;
    color: inherit;
    transition: background 100ms, padding 100ms, margin 100ms;
  }

  .article-link:hover .article-title {
    color: var(--accent);
  }

  .article-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-style: italic;
    color: var(--fg);
    transition: color 0.2s;
  }

  .article-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .tag {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--fg-muted);
    background: var(--bg-elevated);
    padding: 0.125rem 0.375rem;
  }

  .vim-hint {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--fg-muted);
    opacity: 0.5;
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .vim-hint kbd {
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    padding: 0.125rem 0.375rem;
    font-size: var(--text-xs);
  }

  @media (max-width: 640px) {
    .vim-hint {
      display: none;
    }
  }
</style>

<script>
  const searchContainer = document.getElementById('search-container');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const articleList = document.getElementById('article-list');
  const articles = articleList?.querySelectorAll('li') || [];

  let selectedIndex = -1;
  let isSearchActive = false;
  let visibleArticles: HTMLLIElement[] = [];

  function updateVisibleArticles() {
    visibleArticles = Array.from(articles).filter(
      (li) => !li.classList.contains('hidden')
    ) as HTMLLIElement[];
  }

  function clearSelection() {
    articles.forEach((li) => li.classList.remove('selected'));
  }

  function selectArticle(index: number) {
    clearSelection();
    if (index >= 0 && index < visibleArticles.length) {
      selectedIndex = index;
      visibleArticles[index].classList.add('selected');
      visibleArticles[index].scrollIntoView({ block: 'nearest' });
    }
  }

  function openSearch() {
    isSearchActive = true;
    searchContainer?.classList.add('active');
    searchInput?.focus();
    updateVisibleArticles();
    if (selectedIndex === -1 && visibleArticles.length > 0) {
      selectArticle(0);
    }
  }

  function closeSearch() {
    isSearchActive = false;
    searchContainer?.classList.remove('active');
    if (searchInput) searchInput.value = '';
    articles.forEach((li) => li.classList.remove('hidden'));
    clearSelection();
    selectedIndex = -1;
    updateVisibleArticles();
  }

  function filterArticles(query: string) {
    const q = query.toLowerCase();
    articles.forEach((li) => {
      const link = li.querySelector('.article-link') as HTMLAnchorElement;
      const title = link?.dataset.title || '';
      if (title.includes(q)) {
        li.classList.remove('hidden');
      } else {
        li.classList.add('hidden');
      }
    });
    updateVisibleArticles();
    if (visibleArticles.length > 0) {
      selectArticle(0);
    } else {
      selectedIndex = -1;
      clearSelection();
    }
  }

  function navigateToSelected() {
    if (selectedIndex >= 0 && selectedIndex < visibleArticles.length) {
      const link = visibleArticles[selectedIndex].querySelector('.article-link') as HTMLAnchorElement;
      if (link) window.location.href = link.href;
    }
  }

  // Search input handler
  searchInput?.addEventListener('input', (e) => {
    filterArticles((e.target as HTMLInputElement).value);
  });

  // Global keyboard handler
  document.addEventListener('keydown', (e) => {
    const active = document.activeElement;
    const isInputFocused = active?.tagName === 'INPUT' ||
                           active?.tagName === 'TEXTAREA' ||
                           (active as HTMLElement)?.isContentEditable;

    // Handle search input
    if (isSearchActive && active === searchInput) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeSearch();
        return;
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        navigateToSelected();
        return;
      }
      if (e.key === 'ArrowDown' || (e.ctrlKey && e.key === 'n')) {
        e.preventDefault();
        if (selectedIndex < visibleArticles.length - 1) {
          selectArticle(selectedIndex + 1);
        }
        return;
      }
      if (e.key === 'ArrowUp' || (e.ctrlKey && e.key === 'p')) {
        e.preventDefault();
        if (selectedIndex > 0) {
          selectArticle(selectedIndex - 1);
        }
        return;
      }
      return;
    }

    // Don't handle if input focused
    if (isInputFocused) return;

    // Vim-style navigation
    if (e.key === '/') {
      e.preventDefault();
      openSearch();
      return;
    }

    if (e.key === 'j') {
      e.preventDefault();
      updateVisibleArticles();
      if (selectedIndex < visibleArticles.length - 1) {
        selectArticle(selectedIndex + 1);
      } else if (selectedIndex === -1 && visibleArticles.length > 0) {
        selectArticle(0);
      }
      return;
    }

    if (e.key === 'k') {
      e.preventDefault();
      updateVisibleArticles();
      if (selectedIndex > 0) {
        selectArticle(selectedIndex - 1);
      } else if (selectedIndex === -1 && visibleArticles.length > 0) {
        selectArticle(visibleArticles.length - 1);
      }
      return;
    }

    if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      navigateToSelected();
      return;
    }

    if (e.key === 'Escape') {
      closeSearch();
      return;
    }

    // gg - go to top
    if (e.key === 'g') {
      updateVisibleArticles();
      if (visibleArticles.length > 0) {
        selectArticle(0);
      }
      return;
    }

    // G - go to bottom
    if (e.key === 'G') {
      updateVisibleArticles();
      if (visibleArticles.length > 0) {
        selectArticle(visibleArticles.length - 1);
      }
      return;
    }
  });

  // Initialize
  updateVisibleArticles();
</script>
