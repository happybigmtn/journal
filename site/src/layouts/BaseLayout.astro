---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  ogType?: string;
  publishedTime?: Date;
  tags?: string[];
}

const {
  title,
  description = 'A personal journal - thoughts, gratitude, lessons.',
  ogImage,
  ogType = 'website',
  publishedTime,
  tags = [],
} = Astro.props;

const currentPath = Astro.url.pathname;
const canonicalURL = new URL(currentPath, Astro.site);
const ogImageURL = ogImage ? new URL(ogImage, Astro.site).toString() : undefined;

// Navigation items with shortcut keys (letter to underline)
const navItems = [
  { href: '/', label: 'Entries', shortcut: 'e' },
  { href: '/timeline', label: 'Timeline', shortcut: 't' },
  { href: '/insights', label: 'Insights', shortcut: 'i' },
  { href: '/articles', label: 'Articles', shortcut: 'a' },
  { href: '/generator', label: 'Generator', shortcut: 'g' },
];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title}</title>
  <link rel="canonical" href={canonicalURL}>

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content={ogType}>
  <meta property="og:url" content={canonicalURL}>
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  {ogImageURL && <meta property="og:image" content={ogImageURL} />}
  {ogImageURL && <meta property="og:image:width" content="1200" />}
  {ogImageURL && <meta property="og:image:height" content="630" />}
  {publishedTime && <meta property="article:published_time" content={publishedTime.toISOString()} />}
  {tags.map(tag => <meta property="article:tag" content={tag} />)}

  <!-- Twitter Card -->
  <meta name="twitter:card" content={ogImageURL ? 'summary_large_image' : 'summary'}>
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  {ogImageURL && <meta name="twitter:image" content={ogImageURL} />}
  <!-- Wabi-sabi typography: EB Garamond (hand-cut imperfections), Alegreya Sans (warm earthy), IBM Plex Mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Alegreya+Sans:ital,wght@0,300;0,400;0,500;1,400&family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- RSS autodiscovery -->
  <link rel="alternate" type="application/rss+xml" title="Journal RSS Feed" href="/rss.xml" />
  <!-- PWA manifest and icons -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Journal">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
</head>
<body>
  <div id="offline-indicator" class="offline-indicator" aria-live="polite" hidden>
    You are offline
  </div>
  <a href="#main" class="skip-link">Skip to content</a>
  <nav class="site-nav" aria-label="Main navigation">
    <ul class="nav-list">
      {navItems.map(item => {
        const isActive = currentPath === item.href ||
          (item.href !== '/' && currentPath.startsWith(item.href));
        // Underline the shortcut letter
        const shortcutIndex = item.label.toLowerCase().indexOf(item.shortcut);
        const before = item.label.slice(0, shortcutIndex);
        const letter = item.label.slice(shortcutIndex, shortcutIndex + 1);
        const after = item.label.slice(shortcutIndex + 1);
        return (
          <li>
            <a href={item.href} class:list={['nav-link', { active: isActive }]} aria-current={isActive ? 'page' : undefined}>
              {before}<span class="shortcut-key">{letter}</span>{after}
            </a>
          </li>
        );
      })}
    </ul>
  </nav>
  <main id="main" class="container">
    <slot />
  </main>
  <script>
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }

    // Offline indicator
    const offlineIndicator = document.getElementById('offline-indicator');

    function updateOnlineStatus() {
      if (offlineIndicator) {
        offlineIndicator.hidden = navigator.onLine;
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  </script>
  <script>
    // Sortable tables - automatically enable on all tables with thead
    function initSortableTables() {
      const tables = document.querySelectorAll('table');

      tables.forEach(table => {
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        if (!thead || !tbody) return;

        const headers = thead.querySelectorAll('th');
        if (headers.length === 0) return;

        headers.forEach((header, columnIndex) => {
          // Skip if marked as non-sortable
          if (header.hasAttribute('data-no-sort')) return;

          header.addEventListener('click', () => {
            sortTable(table, tbody, headers, columnIndex);
          });

          // Make keyboard accessible
          header.setAttribute('tabindex', '0');
          header.setAttribute('role', 'button');
          header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              sortTable(table, tbody, headers, columnIndex);
            }
          });
        });
      });
    }

    function sortTable(table, tbody, headers, columnIndex) {
      const header = headers[columnIndex];

      // Determine sort direction
      const currentSort = header.getAttribute('data-sort');
      const newSort = currentSort === 'asc' ? 'desc' : 'asc';

      // Clear all sort indicators
      headers.forEach(h => h.removeAttribute('data-sort'));
      header.setAttribute('data-sort', newSort);

      // Get rows and sort
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort((a, b) => {
        const cellA = a.cells[columnIndex];
        const cellB = b.cells[columnIndex];
        if (!cellA || !cellB) return 0;

        let valueA = cellA.getAttribute('data-value') || cellA.textContent || '';
        let valueB = cellB.getAttribute('data-value') || cellB.textContent || '';

        // Detect and handle different data types
        const numA = parseFloat(valueA.replace(/[^0-9.-]/g, ''));
        const numB = parseFloat(valueB.replace(/[^0-9.-]/g, ''));

        let comparison = 0;

        if (!isNaN(numA) && !isNaN(numB)) {
          // Numeric comparison
          comparison = numA - numB;
        } else {
          // String comparison (case-insensitive)
          comparison = valueA.toString().toLowerCase().localeCompare(
            valueB.toString().toLowerCase()
          );
        }

        return newSort === 'asc' ? comparison : -comparison;
      });

      // Re-append rows in sorted order
      rows.forEach(row => tbody.appendChild(row));
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', initSortableTables);
  </script>
  <script>
    // Single-key keyboard navigation
    (function() {
      const shortcuts: Record<string, string> = {
        'e': '/',           // entries
        'h': '/',           // home
        't': '/timeline',   // timeline
        'i': '/insights',   // insights
        'a': '/articles',   // articles
        'g': '/generator',  // generator
        's': '/search',     // search
      };

      function isInputFocused() {
        const active = document.activeElement;
        if (!active) return false;
        const tag = active.tagName.toLowerCase();
        return tag === 'input' || tag === 'textarea' || tag === 'select' ||
               (active as HTMLElement).isContentEditable;
      }

      function showHelp() {
        const existingModal = document.getElementById('keyboard-help');
        if (existingModal) {
          existingModal.remove();
          return;
        }

        const modal = document.createElement('div');
        modal.id = 'keyboard-help';
        modal.innerHTML = `
          <div class="kb-overlay"></div>
          <div class="kb-modal">
            <h2>Keyboard Shortcuts</h2>
            <dl>
              <dt><kbd>e</kbd></dt><dd>Entries</dd>
              <dt><kbd>t</kbd></dt><dd>Timeline</dd>
              <dt><kbd>i</kbd></dt><dd>Insights</dd>
              <dt><kbd>a</kbd></dt><dd>Articles</dd>
              <dt><kbd>g</kbd></dt><dd>Generator</dd>
              <dt><kbd>s</kbd></dt><dd>Search</dd>
              <dt><kbd>?</kbd></dt><dd>Help</dd>
            </dl>
            <button class="kb-close" aria-label="Close">&times;</button>
          </div>
        `;
        document.body.appendChild(modal);

        const close = () => modal.remove();
        modal.querySelector('.kb-overlay')?.addEventListener('click', close);
        modal.querySelector('.kb-close')?.addEventListener('click', close);
      }

      document.addEventListener('keydown', (e) => {
        if (isInputFocused()) return;

        const key = e.key.toLowerCase();

        if (key === 'escape') {
          const modal = document.getElementById('keyboard-help');
          if (modal) modal.remove();
          return;
        }

        if (key === '?' || (e.shiftKey && key === '/')) {
          e.preventDefault();
          showHelp();
          return;
        }

        if (shortcuts[key]) {
          e.preventDefault();
          window.location.href = shortcuts[key];
        }
      });
    })();
  </script>
  <style is:global>
    #keyboard-help {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #keyboard-help .kb-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
    }
    #keyboard-help .kb-modal {
      position: relative;
      background: var(--white);
      color: var(--black);
      border: var(--border-thin);
      padding: 1.5rem 2rem;
      max-width: 280px;
      width: 90%;
      font-family: var(--font-mono);
    }
    #keyboard-help h2 {
      font-family: var(--font-display);
      font-size: var(--text-lg);
      margin-bottom: 1rem;
      border-bottom: var(--border-hairline);
      padding-bottom: 0.5rem;
    }
    #keyboard-help dl {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.25rem 1rem;
      font-size: var(--text-sm);
    }
    #keyboard-help dt {
      text-align: right;
    }
    #keyboard-help dd {
      color: var(--muted-foreground);
    }
    #keyboard-help kbd {
      display: inline-block;
      background: var(--muted);
      border: 1px solid var(--border-hairline-color);
      padding: 0.125rem 0.375rem;
      font-size: var(--text-xs);
      min-width: 1.25rem;
      text-align: center;
    }
    #keyboard-help .kb-close {
      position: absolute;
      top: 0.25rem;
      right: 0.5rem;
      background: none;
      border: none;
      font-size: var(--text-xl);
      cursor: pointer;
      color: var(--muted-foreground);
      line-height: 1;
      padding: 0.25rem;
    }
    #keyboard-help .kb-close:hover {
      color: var(--black);
    }
  </style>
</body>
</html>
