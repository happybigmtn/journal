---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  ogType?: string;
  publishedTime?: Date;
  tags?: string[];
}

const {
  title,
  description = 'A personal journal - thoughts, gratitude, lessons.',
  ogImage,
  ogType = 'website',
  publishedTime,
  tags = [],
} = Astro.props;

const currentPath = Astro.url.pathname;
const canonicalURL = new URL(currentPath, Astro.site);
const ogImageURL = ogImage ? new URL(ogImage, Astro.site).toString() : undefined;

// Navigation items
const navItems = [
  { href: '/', label: 'Archive' },
  { href: '/timeline', label: 'Timeline' },
  { href: '/calendar', label: 'Calendar' },
  { href: '/tags', label: 'Tags' },
  { href: '/insights', label: 'Insights' },
  { href: '/gratitude', label: 'Gratitude' },
  { href: '/people', label: 'People' },
  { href: '/search', label: 'Search' },
];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title}</title>
  <link rel="canonical" href={canonicalURL}>

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content={ogType}>
  <meta property="og:url" content={canonicalURL}>
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  {ogImageURL && <meta property="og:image" content={ogImageURL} />}
  {ogImageURL && <meta property="og:image:width" content="1200" />}
  {ogImageURL && <meta property="og:image:height" content="630" />}
  {publishedTime && <meta property="article:published_time" content={publishedTime.toISOString()} />}
  {tags.map(tag => <meta property="article:tag" content={tag} />)}

  <!-- Twitter Card -->
  <meta name="twitter:card" content={ogImageURL ? 'summary_large_image' : 'summary'}>
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  {ogImageURL && <meta name="twitter:image" content={ogImageURL} />}
  <!-- Editorial typography: Playfair Display (headlines), Source Serif 4 (body), JetBrains Mono (dates/code) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@400;500;600&family=Source+Serif+4:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
  <!-- RSS autodiscovery -->
  <link rel="alternate" type="application/rss+xml" title="Journal RSS Feed" href="/rss.xml" />
  <!-- PWA manifest and icons -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Journal">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
  <script is:inline>
    // Apply saved theme before render to prevent flash
    (function() {
      const theme = localStorage.getItem('theme');
      if (theme) {
        document.documentElement.setAttribute('data-theme', theme);
      }
    })();
  </script>
</head>
<body>
  <div id="offline-indicator" class="offline-indicator" aria-live="polite" hidden>
    You are offline
  </div>
  <a href="#main" class="skip-link">Skip to content</a>
  <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
    <span class="theme-icon-light">☀</span>
    <span class="theme-icon-dark">☾</span>
  </button>
  <nav class="site-nav" aria-label="Main navigation">
    <ul class="nav-list">
      {navItems.map(item => {
        const isActive = currentPath === item.href ||
          (item.href !== '/' && currentPath.startsWith(item.href));
        return (
          <li>
            <a href={item.href} class:list={['nav-link', { active: isActive }]} aria-current={isActive ? 'page' : undefined}>
              {item.label}
            </a>
          </li>
        );
      })}
    </ul>
  </nav>
  <main id="main" class="container">
    <slot />
  </main>
  <script>
    const toggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    function getEffectiveTheme() {
      const saved = localStorage.getItem('theme');
      if (saved) return saved;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function updateToggleVisibility() {
      const theme = getEffectiveTheme();
      toggle?.classList.toggle('is-dark', theme === 'dark');
    }

    toggle?.addEventListener('click', () => {
      const current = getEffectiveTheme();
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      html.setAttribute('data-theme', next);
      updateToggleVisibility();
    });

    // Listen for system preference changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (!localStorage.getItem('theme')) {
        updateToggleVisibility();
      }
    });

    updateToggleVisibility();
  </script>
  <script>
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }

    // Offline indicator
    const offlineIndicator = document.getElementById('offline-indicator');

    function updateOnlineStatus() {
      if (offlineIndicator) {
        offlineIndicator.hidden = navigator.onLine;
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  </script>
  <script>
    // Sortable tables - automatically enable on all tables with thead
    function initSortableTables() {
      const tables = document.querySelectorAll('table');

      tables.forEach(table => {
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        if (!thead || !tbody) return;

        const headers = thead.querySelectorAll('th');
        if (headers.length === 0) return;

        headers.forEach((header, columnIndex) => {
          // Skip if marked as non-sortable
          if (header.hasAttribute('data-no-sort')) return;

          header.addEventListener('click', () => {
            sortTable(table, tbody, headers, columnIndex);
          });

          // Make keyboard accessible
          header.setAttribute('tabindex', '0');
          header.setAttribute('role', 'button');
          header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              sortTable(table, tbody, headers, columnIndex);
            }
          });
        });
      });
    }

    function sortTable(table, tbody, headers, columnIndex) {
      const header = headers[columnIndex];

      // Determine sort direction
      const currentSort = header.getAttribute('data-sort');
      const newSort = currentSort === 'asc' ? 'desc' : 'asc';

      // Clear all sort indicators
      headers.forEach(h => h.removeAttribute('data-sort'));
      header.setAttribute('data-sort', newSort);

      // Get rows and sort
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort((a, b) => {
        const cellA = a.cells[columnIndex];
        const cellB = b.cells[columnIndex];
        if (!cellA || !cellB) return 0;

        let valueA = cellA.getAttribute('data-value') || cellA.textContent || '';
        let valueB = cellB.getAttribute('data-value') || cellB.textContent || '';

        // Detect and handle different data types
        const numA = parseFloat(valueA.replace(/[^0-9.-]/g, ''));
        const numB = parseFloat(valueB.replace(/[^0-9.-]/g, ''));

        let comparison = 0;

        if (!isNaN(numA) && !isNaN(numB)) {
          // Numeric comparison
          comparison = numA - numB;
        } else {
          // String comparison (case-insensitive)
          comparison = valueA.toString().toLowerCase().localeCompare(
            valueB.toString().toLowerCase()
          );
        }

        return newSort === 'asc' ? comparison : -comparison;
      });

      // Re-append rows in sorted order
      rows.forEach(row => tbody.appendChild(row));
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', initSortableTables);
  </script>
</body>
</html>
