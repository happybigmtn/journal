---
import BaseLayout from './BaseLayout.astro';
import { getCollection } from 'astro:content';

const { entry } = Astro.props;
const { Content } = await entry.render();

// Get all entries for prev/next navigation
// In production, only show published entries; in dev, show all non-draft entries
const allEntries = await getCollection('journal', ({ data }) =>
  !data.draft && (import.meta.env.DEV || data.published)
);
const sortedEntries = allEntries.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
const currentIndex = sortedEntries.findIndex(e => e.slug === entry.slug);
const prevEntry = sortedEntries[currentIndex + 1];
const nextEntry = sortedEntries[currentIndex - 1];

// "On This Day" - find entries from same month-day in previous years
const currentDate = entry.data.date;
const currentMonth = currentDate.getMonth();
const currentDay = currentDate.getDate();
const currentYear = currentDate.getFullYear();

const onThisDayEntries = allEntries
  .filter(e => {
    const d = e.data.date;
    return d.getMonth() === currentMonth &&
           d.getDate() === currentDay &&
           d.getFullYear() !== currentYear;
  })
  .sort((a, b) => b.data.date.getFullYear() - a.data.date.getFullYear());

const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const formatShortDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
};

const yearsAgo = (year: number) => {
  const diff = currentYear - year;
  return diff === 1 ? '1 year ago' : `${diff} years ago`;
};

// Word count and reading time
const WORDS_PER_MINUTE = 200;
const wordCount = entry.body
  .replace(/---[\s\S]*?---/, '') // Remove frontmatter
  .replace(/```[\s\S]*?```/g, '') // Remove code blocks
  .replace(/[#*_~`\[\]()>|-]/g, '') // Remove markdown syntax
  .trim()
  .split(/\s+/)
  .filter(word => word.length > 0)
  .length;

const readingTime = Math.max(1, Math.ceil(wordCount / WORDS_PER_MINUTE));

// Generate excerpt for OG description
const excerpt = entry.body
  .replace(/---[\s\S]*?---/, '')
  .replace(/```[\s\S]*?```/g, '')
  .replace(/[#*_~`\[\]()>|-]/g, '')
  .replace(/\n+/g, ' ')
  .trim()
  .slice(0, 150) + '...';

// OG image: use custom if set, otherwise use auto-generated (only for published)
const ogImage = entry.data.og_image || (entry.data.published ? `/og/${entry.slug}.png` : undefined);
---

<BaseLayout
  title={entry.data.title}
  description={excerpt}
  ogImage={ogImage}
  ogType="article"
  publishedTime={entry.data.date}
  tags={entry.data.tags}
>
  <header class="site-header">
    <a href="/">← Archive</a>
  </header>

  <article>
    <header class="entry-header">
      <p class="entry-date">{formatDate(entry.data.date)}</p>
      <div class="entry-meta">
        {entry.data.published && (
          <span class="entry-published" title="Published to public site">PUBLIC</span>
        )}
        <span class="entry-reading-time">{readingTime} min read</span>
        <span class="entry-word-count">{wordCount.toLocaleString()} words</span>
        {entry.data.mood && <span class="entry-mood">Mood: {entry.data.mood}</span>}
        {entry.data.sleep_hours !== undefined && (
          <span class="entry-sleep">Sleep: {entry.data.sleep_hours}h</span>
        )}
        {entry.data.energy !== undefined && (
          <span class="entry-energy">
            Energy: <span class="energy-dots">{'●'.repeat(entry.data.energy)}{'○'.repeat(10 - entry.data.energy)}</span>
          </span>
        )}
      </div>
    </header>

    <div class="entry-content">
      <Content />
    </div>

    {entry.data.tags.length > 0 && (
      <div class="tags">
        {entry.data.tags.map(tag => (
          <a href={`/tags/${tag}`}>#{tag}</a>
        ))}
      </div>
    )}

    {entry.data.habits && entry.data.habits.length > 0 && (
      <div class="habits-display">
        <h3>Habits</h3>
        <ul class="habit-list">
          {entry.data.habits.map(habit => (
            <li class="habit-item">
              {habit.done !== undefined ? (
                <>
                  <span class={`habit-check ${habit.done ? 'done' : ''}`}>
                    {habit.done ? '✓' : '○'}
                  </span>
                  <span class="habit-name">{habit.name}</span>
                </>
              ) : habit.value !== undefined ? (
                <>
                  <span class="habit-value">
                    {habit.value}{habit.goal ? `/${habit.goal}` : ''}
                  </span>
                  <span class="habit-name">{habit.name}</span>
                  {habit.goal && (
                    <span class="habit-progress">
                      <span
                        class="habit-progress-bar"
                        style={`width: ${Math.min(100, (habit.value / habit.goal) * 100)}%`}
                      />
                    </span>
                  )}
                </>
              ) : (
                <span class="habit-name">{habit.name}</span>
              )}
            </li>
          ))}
        </ul>
      </div>
    )}
  </article>

  {onThisDayEntries.length > 0 && (
    <section class="on-this-day">
      <h2>On This Day</h2>
      <ul class="memories-list">
        {onThisDayEntries.map(pastEntry => (
          <li class="memory-item">
            <a href={`/${pastEntry.slug}`}>
              <span class="memory-year">{pastEntry.data.date.getFullYear()}</span>
              <span class="memory-ago">{yearsAgo(pastEntry.data.date.getFullYear())}</span>
              {pastEntry.data.mood && <span class="memory-mood">{pastEntry.data.mood}</span>}
              <span class="memory-title">{pastEntry.data.title}</span>
            </a>
          </li>
        ))}
      </ul>
      <a href="/on-this-day" class="view-all-memories">View all memories →</a>
    </section>
  )}

  <nav class="nav">
    {prevEntry ? (
      <a href={`/${prevEntry.slug}`}>← {formatShortDate(prevEntry.data.date)}</a>
    ) : <span></span>}
    {nextEntry ? (
      <a href={`/${nextEntry.slug}`}>{formatShortDate(nextEntry.data.date)} →</a>
    ) : <span></span>}
  </nav>
</BaseLayout>
